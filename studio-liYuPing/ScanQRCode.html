<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>长按识别二维码DOM</title>
    <link rel="stylesheet" href="css/mui.min.css" type="text/css">
    <link rel="stylesheet" href="css/animate.min.css" type="text/css">
    <link rel="stylesheet" href="css/main.css" type="text/css">
<style>
    .tl-taber{
        position: fixed;
        bottom: 0px;
        right: 0;
        z-index: 9;
    }
    .tl-taber span{
        display: block;
        width: 50px;
        height: 50px;
        border-radius: 55px;
        color: #fff;
        text-align: center;
        line-height: 50px;
        background-color: #f94636;
    }
</style>
</head>
<body style="background-color: #fff">
<!--<header class="mui-bar mui-bar-nav ">-->
    <!--<a class="mui-icon mui-icon-left-nav mui-pull-left"></a>-->
    <!--<h1 class="mui-title">长按识别二维码DOM</h1>-->
<!--</header>-->
<div class="mui-content">
<div style="background-color: #fff;padding: 10px">
    <div class="sys-img">
        <img id="showImg1" src="img/20181217142938.png">
        <div class="show-img" data-id="showImg1"></div>
    </div>
    <p style="text-align: center;line-height: 40px">长按上方图片识别图中二维码</p>
    <div class="sys-img">
        <img id="showImg2" src="img/20181224162745.jpg">
        <div class="show-img" data-id="showImg2"></div>
    </div>
    <div>
        <input type="file" accept="image/*" capture="camera">
        <input type="file" accept="video/*" capture="camcorder">
        <input type="file" accept="audio/*" capture="microphone">
    </div>

</div>
    <div id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action ">
        <!-- 可选择菜单 -->
        <ul class="mui-table-view">
            <li class="mui-table-view-cell" onclick="alertChange(1)" >
                <a class="sys-ewmg" style="color: #333333">识别图中二维码</a>
            </li>
            <li class="mui-table-view-cell" id="cplink" onclick="alertChange(2)">
                <a class="copy-link"   style="color: #333333">复制课程链接</a>
            </li>
            <li class="mui-table-view-cell" onclick="alertChange(3)">
                <a style="color: #333333">下载图片</a>
            </li>
            <li class="mui-table-view-cell" onclick="alertChange(4)">
                <a style="color: #333333">录音</a>
            </li>
        </ul>
        <!-- 取消菜单 -->
        <ul class="mui-table-view">
            <li class="mui-table-view-cell">
                <a href="#sheet1" style="color: #ea4336">取消</a>
            </li>
        </ul>
    </div>
    <div class="tl-taber">
        <span class="tl-home">首页</span>
        <span class="tl-xiaoxi">消息</span>
    </div>

</div>


<script src="js/jquery-3.2.1.min.js"></script>
<script src="js/mui.min.js"></script>
<script src="js/Eleditor-master/webuploader.min.js"></script>
<script src="js/llqrcode.js" type="text/javascript" ></script>
<script src="js/analyticCode.js" type="text/javascript" ></script>
<script src="js/clipboard.min.js"></script>
<script src="js/common.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.3.2.js"></script>
<script>

        function appletOfWeChat() {
            if (window.__wxjs_environment === 'miniprogram') {
                //微信小程序环境
                // wx.miniProgram.navigateTo({
                //     url: "/pages/index/index"
                // })
                // mui.toast("wx.miniProgram.reLaunch")
                wx.miniProgram.switchTab({url: "/pages/index/index"})
            } else {
                //不是小程序环境
            }
        }
        function apptlxiaoxi() {
            if (window.__wxjs_environment === 'miniprogram') {
                wx.miniProgram.postMessage({ data: {foo: 'bar'} })
                wx.miniProgram.getEnv(function(res) {
                    console.log(res.miniprogram) })
            } else {
                //不是小程序环境
            }
        }
        function dwimg() {
            console.log('录音')
            if (window.__wxjs_environment === 'miniprogram') {
                wx.startRecord();
            } else {
                //不是小程序环境
            }
        }
        mui('.tl-taber').on('tap', '.tl-home', function () {

            if (!window.WeixinJSBridge || !WeixinJSBridge.invoke) {
                document.addEventListener('WeixinJSBridgeReady', appletOfWeChat, false)

            } else {
                appletOfWeChat()
            }
        });
        mui('.tl-taber').on('tap', '.tl-xiaoxi', function () {
            apptlxiaoxi()
        })

    //设置
    mui.init({
        gestureConfig:{
            longtap: true,
        }
    });

    // mui('body').on('tap','a',function(){document.location.href=this.href;});
    $('.sys-img').on('longtap','.show-img',function() {
        var imgId=$(this).attr('data-id');
        $('.sys-ewmg').attr('data-id',imgId)
        codeAnalysis(imgId)
    });


function codeAnalysis(imgId) {
    analyticCode.getUrl('img-url',document.getElementById(imgId),function(e){
        if (e=='error decoding QR Code') {
            console.log('解析错误')
        }else {
            $('.sys-ewmg').attr('data-src',e)
            mui('#sheet1').popover('toggle');
        }

    });
}
    function getUrl(e,param){
        analyticCode.getUrl(param,e,function(url,url_2){
            console.log('图片地址:'+url_2)
            window.location="https://hk.yunjy.com.cn/save/qrcode?text=/commoncourse/qrcode%3Fid%3D212165&id=212165&type=course";
            mui('#sheet1').popover('toggle');

        });
    }

    function alertChange(param){
        var imgId=$('.sys-ewmg').attr('data-id');
        var imgSrc=$('.sys-ewmg').attr('data-src');
        if(param === 1){
            mui('#sheet1').popover('toggle');
            window.location.href = imgSrc;
        }else if(param === 2){
            copyLink('cplink', imgSrc);
            mui('#sheet1').popover('toggle');
        }
        else if(param === 3){
            getUrl(document.getElementById(imgId),'img-url');

        }
        else if(param === 4){
            dwimg

        }
    }

</script>
</body>
</html>